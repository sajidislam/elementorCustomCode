add_action('elementor_pro/forms/validation', function ($record, $ajax_handler) {
    // Ensure the email field ID matches the ID in your Elementor form
    $fields = $record->get_field(['id' => 'email']);
    if (empty($fields)) {
        return;
    }

    $field = current($fields);
    $email_value = $field['value'];

    // Check for valid email format
    if (!filter_var($email_value, FILTER_VALIDATE_EMAIL)) {
        $ajax_handler->add_error($field['id'], 'Invalid email format.');
        return;
    }

    // Safely parse the email domain
    $email_parts = explode('@', $email_value);
    if (count($email_parts) !== 2) {
        $ajax_handler->add_error($field['id'], 'Invalid email format.');
        return;
    }
    $domain = end($email_parts);

    // Check for valid email domain (Optional based on server capabilities)
    if (function_exists('checkdnsrr')) {
        if (!checkdnsrr($domain, 'MX')) {
            $ajax_handler->add_error($field['id'], 'Email domain seems invalid. Please use a valid email.');
        }
    }

}, 10, 2);
