// Cleaner code. Moved a lot of the common functions to elementor-form-custom-functions.php 
// make sure that the elementor-form-custom-functions.php exists in the same directory 
// as the functions.php of the (child)theme.

add_action('elementor_pro/forms/validation', function($record, $ajax_handler) {
    require_once get_template_directory() . '/elementor-form-custom-functions.php';

    $fields = $record->get_field(['id' => 'email']);
    if (empty($fields)) {
        $ajax_handler->add_error('email', 'Email cannot be blank');
        return;
    }

    $field = current($fields);

    if (!validateEmail($field['value'])) {
        $ajax_handler->add_error($field['id'], 'Invalid Email Address or Domain');

        $failed_data = [
            'Name' => $record->get_field(['id' => 'name'])[0]['value'],
            'Email' => $field['value'],
            'IP Address' => captureIPAddress(),
            'Date' => current_time('mysql'),
            'Referrer' => captureReferrer(),
            'User Agent' => captureBrowserDetails(),
            'gclid' => readUTMParameters('gclid'),
            'utm_source' => readUTMParameters('utm_source'),
            'utm_medium' => readUTMParameters('utm_medium'),
            'utm_campaign' => readUTMParameters('utm_campaign'),
            'utm_content' => readUTMParameters('utm_content')
        ];

        insertEventToDB('failedEmails', $failed_data);
    }
}, 10, 2);
