// Cleaner code. Moved a lot of the common functions to elementor-form-custom-functions.php 
// make sure that the elementor-form-custom-functions.php exists in the same directory 
// as the functions.php of the (child)theme.

add_action('elementor_pro/forms/validation', function($record, $ajax_handler) {

    // Ensure our custom functions are loaded.
    require_once get_stylesheet_directory() . '/elementor-form-custom-functions.php';

    // Extract submitted form fields.
    $raw_fields = $record->get('fields');
    $fields = [];
    foreach ($raw_fields as $id => $field) {
        $fields[$id] = $field['value'];
    }

    // Name is a required field so it will be entered. Still, sanitize and validate name.
    if (isset($fields['name'])) {
        // Strip tags to prevent XSS, trim to remove whitespace, and sanitize text field.
        $name = sanitize_text_field(trim(strip_tags($fields['name'])));

        // Check if name is empty after sanitization or contains only valid characters.
        if (empty($name)) {
            $ajax_handler->add_error('name', 'Name cannot be blank.');
        } elseif (!preg_match('/^[a-zA-Z\s\'-]+$/', $name)) { // Allow letters, apostrophes, hyphens, and spaces.
            $ajax_handler->add_error('name', 'Name contains invalid characters.');
        }
    }

    // Validate email.
    if (!isset($fields['email']) || empty(trim($fields['email']))) {
        $ajax_handler->add_error('email', 'Email cannot be blank.');
        return;
    }
    //Even though we perform a deeper validation in elementor-form-custom-functions.php
    //nevertheless, i'm using the PHP built-in filter_var function along with FILTER_VALIDATE_EMAIL constant to filter the 
    //email address to determine if it's a valid email address format.
    //p.s: filter_var can also be used URLs, IP addresses, and to sanitize strings, among other things.

	if (!filter_var($fields['email'], FILTER_VALIDATE_EMAIL)) {
        $ajax_handler->add_error('email', 'Invalid email address.');
		return;
    }
	
    if (!validateEmail($fields['email'])) {
        $table_name = 'failedEmails';
	  }
	else {
		$table_name = 'successEmails';
	}
    $additional_data = [
       'IP_Address' => captureIPAddress(),
       'Date' => current_time('mysql'),
       'Referrer' => captureReferrer(),
       'User_Agent' => captureBrowserDetails(),
     ];
    $utm_data = getAllUTMParameters();
    $data_to_insert = array_merge($fields, $additional_data, $utm_data);

     // Insert the data into the database.
    insertEventToDB($table_name, $data_to_insert);

	if ($table_name == 'failedEmails') {
        $ajax_handler->add_error('email', 'Invalid email address.');		
	}
}, 10, 2);
